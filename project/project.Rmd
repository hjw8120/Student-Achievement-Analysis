---
title: "MATH IS FUN IF YOU ANALYZE IT RIGHT!"
author: "LAW Students"
date: "April 28, 2019"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

### Load packages

```{r load-packages, message=FALSE}
library(tidyverse) 
library(broom)
library(infer)
library(ggplot2)
library(shiny)
```

### Load data
```{r load-data, message=FALSE}
students <- read_csv("/cloud/project/data/student-mat.csv")
load("/cloud/project/data/student-new.rdata")
```

### Introduction


### Data Modification

Since we want to study the effect of certain variables on student achievement, the response variable is the student’s overall average grade. For the response variable, we created a new numeric variable called `avg_score` that takes the average of G1, G2, and G3, which corresponds to the term1, term2, and final grades of the students.
```{r avg-score}
students <- students %>%
  mutate(avg_score = ((G1 + G2 + G3)/3))
```

We are comparing achievement levels between first generation and non-first generation Portuguese students. We classify non-first generation students as those who have one or more parent with higher education. To do this, we created a `first_gen` variable that labels first generation students (those with both mothers and fathers who have never attended higher education) as “Yes” and non-first generation students (those with at least one parent who received higher education ) as “No". 
```{r first-gen}
students <- students %>%
  mutate(first_gen = case_when(
    Medu < 4 & Fedu <4 ~ "Yes",
    TRUE ~ "No"
  ))
```

We created two datasets: `first` and `second` for each specific generation. There are 238 observations for first generation students and 157 observations for non-first generation students.
```{r first-dataset}
first <- students %>%
  filter(first_gen == "Yes")
```

```{r second-dataset}
second <- students %>%
  filter(first_gen == "No")
```

### Data Analysis

### Hypothesis Test

We are interested in knowing what factors predict first and non-first generation student academic success, and whether these factors differ from each other in the two groups of students. Before analyzing predictors for each group, we decided to determine whether there exists a significant difference in the level of academic achievement, and if so, the extent of difference, in first and non-first generation students. Here, we conducted a hypothesis test with a bootstrap sample of 1000 to see whether the observed difference in the average math grade of the two groups of students is significant.
```{r obs-diff}
avg_difference <- students %>%
                group_by(first_gen) %>%
  summarize(median = median (avg_score)) %>%
                summarize(diff(median)) %>%
  pull()
```

```{r permute}
set.seed(2019)
null_students <- students %>%
  specify(response = avg_score, explanatory = first_gen) %>%
  hypothesize(null = "independence") %>%
  generate(1000, type = "permute") %>%
  calculate(stat = "diff in medians",
            order = c("No", "Yes"))
```

```{r plot-permute}
ggplot(data= null_students) +
  geom_histogram(mapping = aes(x = stat), binwidth = 0.2) +
  labs(title = "Null distribution of Difference in Median Average Scores",
       x = "Difference in Median Average Scores",
       y = "Frequency") +
  geom_vline(xintercept = avg_difference, color = "red") +
  geom_vline(xintercept = -avg_difference, color = "red")
```
 

```{r p-value}
null_students %>%
  filter(stat >= -avg_difference) %>%
  summarise(p_value = 2 * (n() / 1000))
```

Through hypothesis testing, we obtained a p-value of 0, which indicates that assume two groups have no different in their math performance, there is a 0% probability of seeing the observed difference. This shows that there exists a significant difference between the mathematics performance in first and non-first generation students. Then, we constructed a 95% confidence interval to see how different first and non-first generation students perform. The result shows that we are 95% confident that the true difference between mathematic performance in first and non-first generation students is between -2.54 and -1.06. In other words, it is highly likely that first generation students on average score 2.54 to 1.06 points lower than their non-first generation counterparts. This difference is very significant, considering the average score for all the students is 10.70 with a standard deviation of 3.70. 

```{r boot-avg}
set.seed(2019)
boot_avg <- students %>%
  specify(response = avg_score, explanatory = first_gen) %>%
  generate(reps = 1000, type = "bootstrap") %>%
  calculate(stat = "diff in means", order = c("Yes", "No"))
```

``` {r confidence}
boot_avg %>%
  summarize(lower_bound = quantile(stat, 0.025),
            upper_bound = quantile(stat, 0.975))
```
```{r summary-stats}
students %>%
  summarise(mean = mean(avg_score),
            max = max(avg_score),
            min = min(avg_score),
            sd = sd(avg_score))
```

### Model Selection

Next, we move on to finding predictive factors of mathemathics performance for both groups of students separately. 

We conducted backward model selection on the `first` dataset's full model to determine the variables that are most influential on average student score in first generation students.
```{r first-selection}
first_model <- lm(avg_score ~ school + 
                  sex + age + address + 
                  famsize + Pstatus + 
                  Mjob + Fjob + 
                  reason + guardian + traveltime +
                  studytime + failures + 
                  paid + activities +
                  nursery + higher + internet +
                  romantic + famrel + freetime +
                  goout + Dalc + Walc +
                  health + absences +
                  studytime * failures, data = first)
first_model <- step(first_model, direction = "backward")
tidy(first_model) %>% 
  arrange(p.value) %>%
  select(term, estimate, p.value)
```

avg_score-hat = 10.6 + 1.85 * sexM - 2.40 * failures + 0.702 * studytime - 0.468 * goout + 0.954 * addressU - 0.764 * romanticyes + 0.620 * studytime:failures - 1.22 * PstatusT + 0.401 * Dalc - 0.218 * health

The variables with the lowest p-values, meaning they are most influential on average score in first generation students are: sex, failures, studytime, and goout.

We conducted backward model selection on the `second` dataset's full model to determine the variables that are most influential on average student score in non-first generation students.
```{r non-first}
second_model <- lm(avg_score ~ school + 
                  sex + age + address + 
                  famsize + Pstatus + 
                  Mjob + Fjob + 
                  reason + guardian + traveltime +
                  studytime + failures + 
                  paid + activities +
                  nursery + higher + internet +
                  romantic + famrel + freetime +
                  goout + Dalc + Walc +
                  health + absences +
                  studytime * failures, data = second)
second_model <- step(second_model, direction = "backward")
tidy(second_model) %>% 
  arrange(p.value) %>%
  select(term, estimate, p.value)
```

avg_score-hat = -0.996 - 2.48 * failures + 3.45 * Mjobhealth + 3.76 * Fjobteacher + 8.60 * higheryes + 2.56 * schoolMS + 3.01 * Mjobservices - 0.643 * Dalc + 2.63 * Fjobservices + 1.75 * internetyes - 0.821 * traveltime + 2.12 * Mjobother + 0.478 * freetime - 0.413 * goout + 2.01 * Fjobother + 1.87 * Fjobhealth + 1.32 * Mjobteacher

The variables with the lowest p-values, meaning they are most influential on average score in non-first generation students are: failures, Mjob, Fjob, and higher.

Below is our adjusted r squared value for both models. We are 24.5% confident that the first model predicts the mathematics performance of first generation students. We are 24% confident that the second model predicts the mathematics performance of non-first generation students
```{r}
glance(first_model) $ adj.r.squared
glance(second_model) $ adj.r.squared
```

Here is a shiny app that shows the effects of the influencing variables we chose for both first and non-first generation students using interactive bar and box plots. The influencing variables for First Generation are: failures, sex, studytime, and goout. The influencing variables for Non-First Generation are: failures, Mjob, Fjob, and higher.

```{r shiny-app, echo = F}
# Define UI ---------------------------------------------------------
ui <- fluidPage(
  
  # App title
  titlePanel("Student Achievement"),
  
  # Sidebar layout with a input and output definitions
  sidebarLayout(
    
    # Inputs: Select variables to plot
    sidebarPanel(
      
      # Select variable for y-axis
      selectInput(inputId = "y", 
                  label = "Influencing Variables",
                  choices = c("failures", "Fjob", "goout", "higher", "Mjob", "sex","studytime"), 
                  selected = "failures"),
      
      # Select variable for x-axis
      selectInput(inputId = "x", 
                  label = "Comparison Group",
                  choices = c("first_gen"), 
                  selected = "first_gen"),
      
      radioButtons(inputId="choice", label="What would you like to see?", 
                   choices=c("None","First Generation","Non-First Generation")),
      
      plotOutput(outputId = "maingraph")
    ),
    
    # Output: Show graph
    mainPanel(
      plotOutput(outputId = "graph1"), 
      textOutput(outputId = "influential"),
      plotOutput(outputId = "graph2")
    )
  )
)

# Define server function --------------------------------------------
server <- function(input, output) {
  
  # Create plot object the plotOutput function is expecting
  output$maingraph <- renderPlot({
    ggplot (students, mapping = aes(x = first_gen, y = avg_score)) +
      geom_boxplot() + 
      labs(title = "Average Scores", subtitle = "First and Non-First Generation Students", 
           x = "First Generation", y = "Average Score")  
  })
  
  #Top Graph
  output$graph1 <- renderPlot({
    if(input$y == "failures"){
      ggplot(data = students) +
        geom_bar(mapping = aes(x = first_gen, fill = as.character(failures)), position = "fill") +
        labs(title = "Proportion of Failures",
             x = "First Generation", y = "Proportion", fill = "Number of Failures")
    }
    else if(input$y == "goout"){
      ggplot(data = students) +
        geom_bar(mapping = aes(x = first_gen, fill = as.character(goout)), position = "fill") +
        labs(title = "Proportion of Number of Times Going Out",
             x = "First Generation", y = "Proportion", fill = "Number of Times Go Out")
    }
    else if(input$y == "studytime"){
      ggplot(data = students) +
        geom_bar(mapping = aes(x = first_gen, fill = as.character(studytime)), position = "fill") +
        labs(title = "Proportion of Study Time",
             x = "First Generation", y = "Proportion", fill = "Study Time")
    }
    else if(input$y == "Mjob"){
      ggplot(data = students) +
        geom_bar(mapping = aes(x = first_gen, fill = as.character(Mjob)), position = "fill") +
        labs(title = "Proportion of Mother's Job",
             x = "First Generation", y = "Proportion", fill = "Mother's Job")
    }
    else if(input$y == "Fjob"){
      ggplot(data = students) +
        geom_bar(mapping = aes(x = first_gen, fill = as.character(Fjob)), position = "fill") +
        labs(title = "Proportion of Father's Job",
             x = "First Generation", y = "Proportion", fill = "Father's Job")
    }
    else if(input$y == "higher"){
      ggplot(data = students) +
        geom_bar(mapping = aes(x = first_gen, fill = as.character(higher)), position = "fill") +
        labs(title = "Proportion of Wanting Higher Education",
             x = "First Generation", y = "Proportion", fill = "Higher Education")
    }
    else if(input$y == "sex"){
      ggplot(data = students) +
        geom_bar(mapping = aes(x = first_gen, fill = as.character(sex)), position = "fill") +
        labs(title = "Proportion of Genders",
             x = "First Generation", y = "Proportion", fill = "Gender")
    }
    
  })
  
  # Text
  output$influential <- renderText({
    if(input$choice == "First Generation"){
      if(input$y == "failures" || input$y == "sex" || input$y == "studytime" || input$y == "goout"){
        ""
      }
      else{
        "This variable is not influential in this generation."
      }
    }
    else if(input$choice == "Non-First Generation"){
      if(input$y == "failures" || input$y == "Mjob" || input$y == "Fjob" || input$y == "higher"){
        ""
      }
      else{
        "This variable is not influential in this generation."
      }
    }
  })
  
  # Bottom Graph
  # First Generation ONLY
  output$graph2 <- renderPlot({
    if(input$choice == "First Generation"){
      if(input$y == "goout"){
        ggplot(data = first, mapping = aes(x = as.character(goout), y = avg_score)) +
          geom_boxplot() + labs(title = "Effect of Going Out on Average Score",
                                subtitle = "First Generation",
                                x = "Number of Times Go Out", y = "Average Score")
      }
      else if(input$y == "sex"){
        ggplot(data = first, mapping = aes(x = sex, y = avg_score)) +
          geom_boxplot() + labs(title = "Effect of Gender on Average Score",
                                subtitle = "First Generation",
                                x = "Gender", y = "Average Score")
      }
      else if(input$y == "studytime"){
        ggplot(data = first, mapping = aes(x = as.character(studytime), y = avg_score)) +
          geom_boxplot() + labs(title = "Effect of Study Time on Average Score",
                                subtitle = "First Generation",
                                x = "Study Time", y = "Average Score")
      }
      else if(input$y == "failures"){
        ggplot(data = first, mapping = aes(x = as.character(failures), y = avg_score)) +
          geom_boxplot() + labs(title = "Effect of Failures on Average Score",
                                subtitle = "First Generation",
                                x = "Failures", y = "Average Score")
      }
    }
    
    # Non-First Generation ONLY
    else if(input$choice == "Non-First Generation"){
      if(input$y == "Mjob"){
        ggplot(data = second, mapping = aes(x = Mjob, y = avg_score)) +
          geom_boxplot() + labs(title = "Effect of Mother's Job on Average Score",
                                subtitle = "Non-First Generation",
                                x = "Mother's Job", y = "Average Score")
      }
      else if(input$y == "Fjob"){
        ggplot(data = second, mapping = aes(x = Fjob, y = avg_score)) +
          geom_boxplot() + labs(title = "Effect of Father's Job on Average Score",
                                subtitle = "Non-First Generation",
                                x = "Father's Job", y = "Average Score")
      }
      else if(input$y == "higher"){
        ggplot(data = second, mapping = aes(x = higher, y = avg_score)) +
          geom_boxplot() + labs(title = "Effect of Wanting Higher Education on Average Score",
                                subtitle = "Non-First Generation",
                                x = "Want Higher Education", y = "Average Score")
      }
      else if(input$y == "failures"){
        ggplot(data = second, mapping = aes(x = as.character(failures), y = avg_score)) +
          geom_boxplot() + labs(title = "Effect of Failures on Average Score",
                                subtitle = "Non-First Generation",
                                x = "Failures", y = "Average Score")
      }
    }
  })
}

# Create the Shiny app object ---------------------------------------
shinyApp(ui = ui, server = server)
```

### Conclusion
```{r failure-box}
ggplot(data = students) +
  geom_boxplot(mapping = aes(x = as.character(failures), y = avg_score)) +
  facet_wrap(~ first_gen) +
  labs(title = "Relationship Between Average Scores and Numbers of Past Failures",
       subtitle = "First Generation vs. Non=first Generation",
       x = "First Generation",
       y = "Grade")
```


```{r failures-bar}
ggplot(data = students) +
  geom_bar(mapping = aes(x = first_gen, fill = as.character(failures)), position = "fill") +
  labs(title = "Proportion of Failures in First and Non-first Generation Students",
       x = "First Generation",
       y = "proportions",
       fill = "Number of Failures")
```


```{r mjob}
ggplot(data = students) +
  geom_bar(mapping = aes(x = first_gen, fill = as.character(Mjob)),  position = "fill") +
  labs(title = "Proportion of Mother's Job in First and Non-first Generation Students",
       x = "First Generation",
       y = "proportions",
       fill = "Job") 
```

```{r fjob}
ggplot(data = students) +
  geom_bar(mapping = aes(x = first_gen, fill = as.character(Fjob)),  position = "fill") +
  labs(title = "Proportion of Father's Job in First and Non-first Generation Students",
       x = "First Generation",
       y = "proportions",
       fill = "Job")
```

```{r failure-sex}
ggplot(data = students) +
  geom_boxplot(mapping = aes(x = sex, y = avg_score)) +
  facet_wrap(~ first_gen) +
  labs(title = "Relationship Between Average Scores and Sex",
       subtitle = "First Generation vs. Non=first Generation",
       x = "First Generation",
       y = "Grade")
```









